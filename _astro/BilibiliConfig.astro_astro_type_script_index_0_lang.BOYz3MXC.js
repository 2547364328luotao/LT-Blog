class A{static getProxiedUrl(t,s="wsrv"){if(!t)return"";let i=t;switch(i.startsWith("http://")&&(i=i.replace("http://","https://")),i.startsWith("//")&&(i="https:"+i),s){case"wsrv":return`https://wsrv.nl/?url=${encodeURIComponent(i)}&w=400&h=225&fit=cover&output=webp`;case"imageproxy":return`https://imageproxy.net/400x225,fit,q85/${encodeURIComponent(i)}`;case"none":default:return i}}static getImageUrls(t){const s=[],i=this.getProxiedUrl(t,"none");return s.push(i),s.push(this.getProxiedUrl(t,"wsrv")),s.push("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIyNSIgdmlld0JveD0iMCAwIDQwMCAyMjUiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjI1IiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0xNzUgODVIMjI1VjE0MEgxNzVWODVaIiBmaWxsPSIjQ0NDIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTcwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiPuinhumikeeVhOWksei0pTwvdGV4dD4KPC9zdmc+"),s}static getImageAttributes(t,s=""){const i=this.getImageUrls(t);return{src:i[0],"data-src-backup":i[1],"data-src-placeholder":i[2],alt:s,loading:"lazy",crossorigin:"anonymous",referrerpolicy:"no-referrer"}}}const C={cookie:"",baseUrl:"https://api.bilibili.com",userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};class B{config;constructor(t={}){this.config={...C,...t}}setCookie(t){this.config.cookie=t}getCookie(){return this.config.cookie}buildHeaders(){const t={"User-Agent":this.config.userAgent,Referer:"https://www.bilibili.com/",Accept:"application/json, text/plain, */*","Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-site"};return this.config.cookie&&(t.Cookie=this.config.cookie),t}async request(t,s={}){const i=t.startsWith("http")?t:`${this.config.baseUrl}${t}`,n=await fetch(i,{...s,headers:{...this.buildHeaders(),...s.headers}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const a=await n.json();if(a.code!==0)throw new Error(`API Error ${a.code}: ${a.message}`);return a}async getVideoDetail(t){const s=/^\d+$/.test(t),i=/^BV[1-9A-HJ-NP-Za-km-z]{10}$/.test(t);if(!s&&!i)throw new Error("Invalid video ID format. Expected aid (number) or bvid (BV...)");const n=new URLSearchParams;s?n.set("aid",t):n.set("bvid",t);const a=`/x/web-interface/view?${n.toString()}`;return(await this.request(a)).data}async getVideoDescription(t){const s=/^\d+$/.test(t),i=/^BV[1-9A-HJ-NP-Za-km-z]{10}$/.test(t);if(!s&&!i)throw new Error("Invalid video ID format. Expected aid (number) or bvid (BV...)");const n=new URLSearchParams;s?n.set("aid",t):n.set("bvid",t);const a=`/x/web-interface/archive/desc?${n.toString()}`;return(await this.request(a)).data}async getVideoPages(t){const s=/^\d+$/.test(t),i=/^BV[1-9A-HJ-NP-Za-km-z]{10}$/.test(t);if(!s&&!i)throw new Error("Invalid video ID format. Expected aid (number) or bvid (BV...)");const n=new URLSearchParams;s?n.set("aid",t):n.set("bvid",t);const a=`/x/player/pagelist?${n.toString()}`;return(await this.request(a)).data}async getMultipleVideos(t){const s=[];for(let i=0;i<t.length;i++)try{const n=await this.getVideoDetail(t[i]);s.push(n),i<t.length-1&&await new Promise(a=>setTimeout(a,1e3))}catch(n){console.error(`Failed to fetch video ${t[i]}:`,n)}return s}}function E(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=e%60;return t>0?`${t}:${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${s}:${i.toString().padStart(2,"0")}`}function x(e){const t=new Date(e*1e3),s=t.getFullYear(),i=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0");return`${s}-${i}-${n}`}function V(e){const t=A.getImageUrls(e.pic);return{title:e.title,bvid:e.bvid,description:e.desc,cover:t[0],duration:E(e.duration),publishDate:x(e.pubdate),views:e.stat.view,likes:e.stat.like,danmaku:e.stat.danmaku,tags:[],url:`https://www.bilibili.com/video/${e.bvid}`}}const f=new B,o={videoIds:["BV1kseje8EXt","BV1EBaQeDE1z","BV1RWe6eEEtH","BV1AA4y1A7AA","BV1AxeDeZEgc"],useDynamicData:!1,cookie:""},k=async(e,t)=>{try{const s=await f.getVideoDetail(e);return V(s)}catch(s){return console.error(`Failed to fetch video ${e}:`,s),null}},l=e=>{f.setCookie(e),o.cookie=e,o.useDynamicData=!0},I=()=>f.getCookie(),u="bilibili_sessdata",y="bilibili_config";class r{static loadSessdata(){return typeof window<"u"&&localStorage.getItem(u)||""}static saveSessdata(t){typeof window<"u"&&localStorage.setItem(u,t),l(t)}static clearSessdata(){typeof window<"u"&&localStorage.removeItem(u),l("")}static isValidSessdata(t){return t.length>20&&/^[a-zA-Z0-9%]+$/.test(t)}static initializeConfig(){const t=this.loadSessdata();t&&this.isValidSessdata(t)&&l(t)}static getConfigStatus(){const t=I();return{hasValidSessdata:this.isValidSessdata(t),isUsingDynamicData:o.useDynamicData,sessdataLength:t.length,videoCount:o.videoIds.length}}static updateVideoIds(t){o.videoIds=t,this.saveConfig()}static saveConfig(){if(typeof window<"u"){const t={videoIds:o.videoIds,useDynamicData:o.useDynamicData};localStorage.setItem(y,JSON.stringify(t))}}static loadConfig(){if(typeof window<"u"){const t=localStorage.getItem(y);if(t)try{const s=JSON.parse(t);s.videoIds&&Array.isArray(s.videoIds)&&(o.videoIds=s.videoIds),typeof s.useDynamicData=="boolean"&&(o.useDynamicData=s.useDynamicData)}catch(s){console.error("Failed to load config:",s)}}}static resetToDefaults(){this.clearSessdata(),o.videoIds=["BV1XX4y1X7XX","BV1YY4y1Y7YY","BV1ZZ4y1Z7ZZ","BV1AA4y1A7AA","BV1BB4y1B7BB"],o.useDynamicData=!1,o.cookie="",this.saveConfig()}}typeof window<"u"&&setTimeout(()=>{r.initializeConfig(),r.loadConfig()},100);const d=document.getElementById("sessdata-input"),m=document.getElementById("video-ids-input"),v=document.getElementById("use-dynamic-data"),g=document.getElementById("toggle-visibility"),$=document.getElementById("save-config"),T=document.getElementById("test-config"),U=document.getElementById("reset-config"),p=document.getElementById("sessdata-status"),S=document.getElementById("dynamic-status"),P=document.getElementById("video-count"),w=document.getElementById("test-result"),c=document.getElementById("test-output");function D(){const e=I();r.getConfigStatus(),d.value=e,m.value=o.videoIds.join(", "),v.checked=o.useDynamicData,b()}function b(){const e=r.getConfigStatus();p.textContent=e.hasValidSessdata?"已设置":"未设置",p.style.color=e.hasValidSessdata?"#28a745":"#dc3545",S.textContent=e.isUsingDynamicData?"已启用":"已禁用",S.style.color=e.isUsingDynamicData?"#28a745":"#6c757d",P.textContent=e.videoCount.toString()}g.addEventListener("click",()=>{const e=g.querySelector(".show-text"),t=g.querySelector(".hide-text");d.type==="password"?(d.type="text",e.style.display="none",t.style.display="inline"):(d.type="password",e.style.display="inline",t.style.display="none")});$.addEventListener("click",async()=>{try{const e=d.value.trim(),t=m.value.split(",").map(i=>i.trim()).filter(i=>i.length>0),s=v.checked;if(s&&(!e||!r.isValidSessdata(e))){alert("请输入有效的SESSDATA");return}if(t.length===0){alert("请至少输入一个视频ID");return}e&&r.saveSessdata(e),r.updateVideoIds(t),o.useDynamicData=s,r.saveConfig(),b(),alert("配置保存成功！")}catch(e){console.error("Failed to save config:",e),alert("保存配置失败："+e.message)}});T.addEventListener("click",async()=>{try{w.style.display="block",c.textContent="正在测试连接...";const e=d.value.trim(),t=m.value.split(",").map(n=>n.trim()).filter(n=>n.length>0);if(!e){c.textContent="错误：未设置SESSDATA";return}if(t.length===0){c.textContent="错误：未设置视频ID";return}const s=t[0];l(e);const i=await k(s);i?c.textContent=`测试成功！

获取到视频信息：
标题：${i.title}
播放量：${i.views}
点赞数：${i.likes}
发布时间：${i.publishDate}`:c.textContent=`测试失败：无法获取视频信息

可能原因：
1. SESSDATA无效或已过期
2. 视频ID不存在
3. 视频需要特殊权限访问
4. 网络连接问题`}catch(e){console.error("Test failed:",e),c.textContent=`测试失败：${e.message}

请检查：
1. SESSDATA是否正确
2. 网络连接是否正常
3. 视频ID格式是否正确`}});U.addEventListener("click",()=>{confirm("确定要重置所有配置吗？这将清除SESSDATA和视频列表设置。")&&(r.resetToDefaults(),D(),w.style.display="none",alert("配置已重置为默认值"))});document.addEventListener("DOMContentLoaded",D);
