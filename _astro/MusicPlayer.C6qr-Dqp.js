import{o as G,a as H,i as J}from"./lifecycle.DPZt2Rd3.js";import{c as O,f as Q,a as V,p as X,b as Y,s as i,m as a,d,g as e}from"./template.Z-zn-6r2.js";import{i as Z}from"./functions.CWCljAFa.js";import{m}from"./config.Dxd-7tPr.js";import"./zh_TW.BX73iyju.js";function ae(_,P){Y(P,!1);let T=m.mode??"meting",g=m.meting_api??"https://www.bilibili.uno/api?server=:server&type=:type&id=:id&auth=:auth&r=:r",y=m.id??"14164869977",b=m.server??"netease",x=m.type??"playlist",c=a(!1),B=a(0),p=a(0),j=a(.7),n=a(!1),L=a(!1),A=a(0),$=a(""),w=a(!1),h=a({title:"示例歌曲",artist:"示例艺术家",cover:"/favicon/favicon-light-192.png",url:"",duration:0}),u=a([]),s=a(0),t=a();const W=[{id:1,title:"ひとり上手",artist:"Kaya",cover:"assets/music/cover/hitori.jpg",url:"assets/music/url/hitori.mp3",duration:240},{id:2,title:"眩耀夜行",artist:"スリーズブーケ",cover:"assets/music/cover/xryx.jpg",url:"assets/music/url/xryx.mp3",duration:180},{id:3,title:"春雷の頃",artist:"22/7",cover:"assets/music/cover/cl.jpg",url:"assets/music/url/cl.mp3",duration:200}];async function k(){if(!g||!y)return;i(n,!0);const r=g.replace(":server",b).replace(":type",x).replace(":id",y).replace(":auth","").replace(":r",Date.now().toString());try{const f=await fetch(r);if(!f.ok)throw new Error("meting api error");const U=await f.json();i(u,U.map(l=>{let q=l.name??l.title??"未知歌曲",z=l.artist??l.author??"未知艺术家",o=l.duration??0;return o>1e4&&(o=Math.floor(o/1e3)),(!Number.isFinite(o)||o<=0)&&(o=0),{id:l.id,title:q,artist:z,cover:l.pic??"",url:l.url??"",duration:o}})),e(u).length>0&&v(e(u)[0]),i(n,!1)}catch{E("Meting 歌单获取失败"),i(n,!1)}}function F(){if(e(u).length<=1)return;let r;if(e(L))do r=Math.floor(Math.random()*e(u).length);while(r===e(s)&&e(u).length>1);else r=e(s)<e(u).length-1?e(s)+1:0;I(r)}function I(r){if(r<0||r>=e(u).length)return;const f=e(c);i(s,r),e(t)&&e(t).pause(),v(e(u)[e(s)]),(f||!e(c))&&setTimeout(()=>{e(t)&&(e(t).readyState>=2?e(t).play().catch(()=>{}):e(t).addEventListener("canplay",()=>{e(t).play().catch(()=>{})},{once:!0}))},100)}function K(r){return r.startsWith("http://")||r.startsWith("https://")||r.startsWith("/")?r:`/${r}`}function v(r){!r||!e(t)||(i(h,{...r}),r.url?(i(n,!0),e(t).pause(),d(t,e(t).currentTime=0),i(B,0),i(p,r.duration??0),e(t).removeEventListener("loadeddata",C),e(t).removeEventListener("error",D),e(t).removeEventListener("loadstart",M),e(t).addEventListener("loadeddata",C,{once:!0}),e(t).addEventListener("error",D,{once:!0}),e(t).addEventListener("loadstart",M,{once:!0}),d(t,e(t).src=K(r.url)),e(t).load()):i(n,!1))}function C(){i(n,!1),e(t)?.duration&&e(t).duration>1&&(i(p,Math.floor(e(t).duration)),e(u)[e(s)]&&d(u,e(u)[e(s)].duration=e(p)),d(h,e(h).duration=e(p)))}function D(r){i(n,!1),E(`无法播放 "${e(h).title}"，正在尝试下一首...`),e(u).length>1?setTimeout(()=>F(),1e3):E("播放列表中没有可用的歌曲")}function M(){}function E(r){i($,r),i(w,!0),setTimeout(()=>{i(w,!1)},3e3)}function N(){e(t)&&(e(t).addEventListener("play",()=>{i(c,!0)}),e(t).addEventListener("pause",()=>{i(c,!1)}),e(t).addEventListener("timeupdate",()=>{i(B,e(t).currentTime)}),e(t).addEventListener("ended",()=>{e(A)===1?(d(t,e(t).currentTime=0),e(t).play().catch(()=>{})):e(A)===2||e(s)<e(u).length-1||e(L)?F():i(c,!1)}),e(t).addEventListener("error",r=>{i(n,!1)}),e(t).addEventListener("stalled",()=>{}),e(t).addEventListener("waiting",()=>{}))}G(()=>{i(t,new Audio),d(t,e(t).volume=e(j)),N(),T==="meting"?k():(i(u,W),e(u).length>0&&v(e(u)[0]))}),H(()=>{e(t)&&(e(t).pause(),d(t,e(t).src=""))}),J();var S=O(),R=Q(S);Z(R,r=>{}),V(_,S),X()}export{ae as default};
